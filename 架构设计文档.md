# 工业场景优化器 架构设计文档

## 1. 系统概述

工业场景优化器是一款智能系统参数优化工具，能够根据系统当前运行状态自动识别工业场景并应用相应的优化参数配置，从而提升系统性能和资源利用率。

### 1.1 主要功能
- **数据收集**：通过集成atune-collector采集系统性能指标数据
- **场景识别**：基于机器学习模型自动识别当前运行场景
- **参数优化**：根据识别的场景应用预定义的优化参数配置
- **持续监控**：支持持续监控模式，定期采集数据并优化系统参数
- **参数备份与恢复**：支持系统原始参数的备份与一键恢复

### 1.2 应用场景
- 工业服务器的性能优化
- 混合负载场景的参数自动调优
- 计算密集型/数据密集型任务的系统配置优化
- 轻量级负载系统的资源利用率提升

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────┐    ┌────────────────────┐    ┌────────────────────┐    ┌───────────────────┐
│                     │    │                    │    │                    │    │                   │
│  数据收集层         │ -> │  数据转换层        │ -> │  场景识别层        │ -> │  参数优化层       │
│  (atune-collector)  │    │  (DataTransformer) │    │  (SceneRecognizer) │    │  (ParamOptimizer) │
│                     │    │                    │    │                    │    │                   │
└─────────────────────┘    └────────────────────┘    └────────────────────┘    └───────────────────┘
         ↑                                                               │
         │                                                               ↓
┌─────────────────────┐    ┌────────────────────┐    ┌────────────────────┐
│                     │    │                    │    │                    │
│  系统参数应用       │ <- │  服务管理层        │ <- │  配置管理层        │
│                     │    │  (service_main.py) │    │  (service_config)  │
│                     │    │                    │    │                    │
└─────────────────────┘    └────────────────────┘    └────────────────────┘
```

### 2.2 分层设计

#### 2.2.1 数据收集层
- 负责采集系统性能指标数据
- 集成atune-collector工具进行数据收集
- 支持配置化的数据收集间隔和采样数量

#### 2.2.2 数据转换层
- 负责处理原始数据，转换为适合场景识别模型使用的格式
- 支持批量处理和单文件处理模式
- 处理多种编码格式的CSV文件

#### 2.2.3 场景识别层
- 基于机器学习模型识别当前系统运行场景
- 支持模型加载、状态检查和场景预测
- 提供批量识别和实时识别功能

#### 2.2.4 参数优化层
- 根据识别的场景应用相应的优化参数配置
- 支持参数备份与恢复机制
- 处理不同操作系统的参数应用差异

#### 2.2.5 服务管理层
- 协调整个系统的运行流程
- 支持持续监控和单次运行模式
- 处理信号和异常情况

#### 2.2.6 配置管理层
- 管理系统配置参数
- 支持配置文件和环境变量两种配置方式
- 定义各模块的路径和运行参数

## 3. 核心模块设计

### 3.1 主服务模块 (service_main.py)

主服务模块是整个系统的核心入口，负责协调整个优化流程的执行。

#### 3.1.1 主要功能
- 加载系统配置
- 初始化各子模块
- 处理命令行参数
- 协调整个优化流程
- 提供持续监控模式

#### 3.1.2 核心流程
```python
# 服务启动流程
def main():
    # 解析命令行参数
    # 初始化服务
    # 根据监控模式执行不同流程
    if monitor_mode == 0:
        # 持续监控模式
        continuous_monitoring()
    else:
        # 单次优化模式
        run_single_optimization()

# 单次优化流程
def run_single_optimization():
    # 收集数据
    # 转换数据
    # 识别场景
    # 应用优化参数
```

### 3.2 数据转换模块 (data_transformer.py)

数据转换模块负责处理原始性能数据，将其转换为适合场景识别模型使用的格式。

#### 3.2.1 主要功能
- 加载原始CSV数据文件
- 支持多种编码格式的文件读取
- 计算数据平均值作为特征
- 批量转换数据文件
- 提供特征提取和预处理功能

#### 3.2.2 类设计
```python
class DataTransformer:
    # 初始化数据转换器
    def __init__(self, config_file=None):
        # 加载配置
        # 初始化数据目录

    # 读取原始数据
    def load_raw_data(self, file_path):
        # 读取CSV文件
        # 处理时间戳

    # 转换数据
    def transform_data(self, df):
        # 计算数值列平均值

    # 转换单个文件
    def transform_file(self, file_path, output_dir=None):
        # 加载原始数据
        # 转换数据
        # 保存转换结果

    # 批量转换文件
    def batch_transform_files(self, input_dir=None, output_dir=None):
        # 遍历目录中的CSV文件
        # 转换每个文件

    # 获取识别数据
    def get_recognition_data(self, file_paths=None):
        # 获取最新数据文件
        # 读取并处理数据
        # 返回特征数据
```

### 3.3 场景识别模块 (scene_recognizer.py)

场景识别模块负责基于处理后的数据识别当前系统运行场景。

#### 3.3.1 主要功能
- 加载场景识别模型
- 提供模型状态检查
- 处理输入数据进行场景预测
- 支持批量识别和实时识别
- 提供特征匹配和缺失处理

#### 3.3.2 类设计
```python
class SceneRecognizer:
    # 初始化场景识别器
    def __init__(self, model_path=None):
        # 设置模型路径
        # 初始化场景映射

    # 加载模型
    def load_model(self):
        # 加载joblib格式的模型
        # 处理加载异常

    # 预处理数据
    def preprocess_data(self, data):
        # 处理不同类型的输入
        # 读取文件或处理DataFrame
        # 清理特征名称
        # 处理重复列
        # 匹配特征

    # 识别场景
    def recognize_scene(self, data):
        # 检查模型状态
        # 预处理数据
        # 执行预测
        # 返回场景名称

    # 获取场景概率
    def get_scene_probabilities(self, data):
        # 执行概率预测
        # 返回概率分布

    # 批量识别
    def batch_recognize(self, file_paths):
        # 批量处理文件
        # 返回识别结果
```

### 3.4 参数优化模块 (param_optimizer.py)

参数优化模块负责根据识别的场景应用相应的系统参数优化配置。

#### 3.4.1 主要功能
- 加载场景参数模板
- 备份系统原始参数
- 应用优化参数配置
- 恢复系统参数
- 支持不同操作系统的参数应用
- 支持多种系统参数的配置（预读缓存、CPU能效、网络参数、服务优化等）

#### 3.4.2 类设计
```python
class ParamOptimizer:
    # 初始化参数优化器
    def __init__(self, config_file=None):
        # 加载配置
        # 初始化模板目录
        # 检测操作系统

    # 加载场景参数
    def load_scene_params(self, scene_name):
        # 加载对应场景的参数文件
        # 处理默认参数

    # 备份原始参数
    def backup_original_params(self):
        # 备份sysctl参数
        # 备份I/O调度器
        # 备份线程限制
        # 备份CPU调节器

    # 恢复参数
    def restore_params(self):
        # 恢复sysctl参数
        # 恢复I/O调度器
        # 恢复线程限制
        # 恢复CPU调节器

    # 应用场景参数
    def apply_scene_params(self, scene_name):
        # 加载场景参数
        # 恢复原始参数
        # 备份当前参数
        # 应用sysctl参数
        # 应用I/O调度器
        # 应用线程限制
        # 应用CPU调节器
        # 应用预读缓存大小
        # 应用CPU空闲状态
        # 应用网络参数
        # 应用服务优化配置
```

#### 3.4.3 关键参数配置说明

参数优化模块支持配置多种系统参数，通过YAML格式的场景参数模板文件定义。以下是支持的主要参数类型及其作用：

##### 3.4.3.1 预读缓存配置
```yaml
read_ahead_kb: 256  # 预读缓存大小（KB）
```
- **说明**：设置存储设备的预读缓存大小，影响数据读取性能
- **适用场景**：轻负载场景设置较小值可减少内存占用，数据密集型场景可适当增大
- **实现机制**：通过修改`/sys/block/{device}/queue/read_ahead_kb`文件实现

##### 3.4.3.2 CPU与能效优化
```yaml
cpu_scheduler: "CFS"  # CPU调度器
cpu_governor: "powersave"  # CPU调节器模式
cpu_idle:
  max_cstate: 3  # 最大CPU空闲状态
```
- **cpu_scheduler**：指定CPU调度策略，默认为CFS（完全公平调度器）
- **cpu_governor**：控制CPU频率调节策略，可选值包括"powersave"（节能）、"performance"（性能）等
- **cpu_idle.max_cstate**：控制CPU深度休眠状态，较低值可提高响应速度，较高值可增强节能效果
- **实现机制**：通过修改`/sys/devices/system/cpu/cpufreq/scaling_governor`及相关空闲状态配置文件实现

##### 3.4.3.3 网络参数优化
```yaml
net:
  core:
    rmem_default: 4194304  # 默认接收缓冲区大小
    wmem_default: 4194304  # 默认发送缓冲区大小
    rmem_max: 16777216     # 最大接收缓冲区大小
    wmem_max: 16777216     # 最大发送缓冲区大小
  ipv4:
    tcp_keepalive_time: 300  # TCP保活时间
```
- **net.core**：配置网络核心参数，包括缓冲区大小设置
- **net.ipv4**：配置IPv4协议相关参数，如TCP连接保活时间
- **实现机制**：通过sysctl命令应用网络参数

##### 3.4.3.4 服务优化配置
```yaml
services:
  disabled:
    - atd      # 定时任务服务
    - auditd   # 审计服务
```
- **services.disabled**：指定需要禁用的系统服务列表，减少系统资源占用
- **实现机制**：在Linux系统上通过systemctl命令禁用和停止服务

##### 3.4.3.5 原有参数配置
除新增参数外，系统还支持配置以下原有参数：
- **sysctl参数**：各种内核参数配置
- **I/O调度器**：配置存储设备的I/O调度策略
- **线程数限制**：限制系统最大线程数
- **自定义脚本**：执行特定的自定义优化脚本

## 4. 数据流程设计

### 4.1 数据收集与处理流程
1. **数据收集**：通过atune-collector采集系统性能指标数据
2. **数据存储**：将采集的数据保存到原始数据目录
3. **数据转换**：DataTransformer模块将原始数据转换为特征数据
4. **特征提取**：计算数据平均值作为场景识别的特征
5. **场景识别**：SceneRecognizer模块基于特征数据识别当前场景
6. **参数应用**：ParamOptimizer模块根据识别的场景应用优化参数
7. **结果记录**：记录参数应用结果和系统状态

### 4.2 数据格式
- **原始数据**：CSV格式，包含时间戳和各类性能指标
- **转换后数据**：CSV格式，包含各指标的平均值
- **模型输入数据**：特征矩阵，用于场景识别模型的输入
- **参数配置**：YAML格式，定义各场景的优化参数

## 5. 配置管理

### 5.1 配置文件 (service_config.conf)

配置文件采用key=value格式，主要包含以下配置项：

| 配置项 | 说明 | 默认值 |
|-------|------|-------|
| monitor_mode | 监控模式（0:持续监控，1:单次监控） | 1 |
| collect_interval | 数据收集间隔（秒） | 3600 |
| sample_num | 每次检测的数据量 | 50 |
| interval | 采样间隔时间 | 6 |
| data_dir | 数据存储目录 | /var/lib/industrial-scene-optimizer/data |
| log_file | 日志文件路径 | /var/log/industrial-scene-optimizer/service.log |
| log_level | 日志级别 | INFO |
| atune_config | atune-collector配置文件路径 | /etc/industrial-scene-optimizer/collect_data.json |
| scene_model_path | 场景识别模型文件路径 | /var/lib/industrial-scene-optimizer/models/scene_recognizer_model.pkl |
| param_templates_dir | 参数模板目录 | /usr/share/industrial-scene-optimizer/templates |

### 5.2 参数模板文件 (YAML格式)

参数模板文件位于模板目录中，采用YAML格式定义各场景的优化参数配置。每个场景对应一个YAML文件，文件名与场景名称一致。

#### 5.2.1 模板文件结构
```yaml
# 场景描述信息
description: "轻量级负载场景优化配置"

# 内核参数配置
sysctl:
  vm.swappiness: 10
  vm.dirty_ratio: 20
  vm.dirty_background_ratio: 10
  # ... 其他sysctl参数

# I/O调度器配置
io_scheduler: "cfq"

# 线程数限制
thread_limit: 512

# CPU调节器配置
cpu_governor: "powersave"

# 预读缓存大小
read_ahead_kb: 256

# CPU空闲状态配置
cpu_idle:
  max_cstate: 3

# 网络参数配置
net:
  core:
    rmem_default: 4194304
    wmem_default: 4194304
    rmem_max: 16777216
    wmem_max: 16777216
  ipv4:
    tcp_keepalive_time: 300

# 服务优化配置
services:
  disabled:
    - atd
    - auditd

# 自定义优化脚本（可选）
custom_scripts:
  script1: "/path/to/custom_script.sh"
```

#### 5.2.2 模板文件加载流程
1. 系统启动时，参数优化器从模板目录加载所有场景的参数模板
2. 场景识别完成后，根据识别结果选择对应的模板文件
3. 加载模板文件中的参数配置，准备应用到系统
4. 在应用参数前，自动备份当前系统参数，以便后续恢复

### 5.3 配置加载机制
- 优先从配置文件加载配置
- 支持通过环境变量覆盖配置文件中的配置
- 为每个配置项提供默认值，确保系统正常运行

### 5.2 配置加载机制
- 优先从配置文件加载配置
- 支持通过环境变量覆盖配置文件中的配置
- 为每个配置项提供默认值，确保系统正常运行

## 6. 部署架构

### 6.1 目录结构
```
/usr/share/industrial-scene-optimizer/       # 主程序目录
├── models/                                  # 模型文件目录
├── templates/                               # 参数模板目录
└── Performance_Data.csv                     # 性能数据文件

/etc/industrial-scene-optimizer/             # 配置文件目录
├── service_config.conf                      # 主配置文件
└── collect_data.json                        # 数据收集配置

/var/lib/industrial-scene-optimizer/data/    # 数据存储目录
├── raw/                                     # 原始数据
└── transformed/                             # 转换后的数据

/var/log/industrial-scene-optimizer/         # 日志目录
```

### 6.2 安装流程
安装脚本(install.sh)负责系统的部署和配置：
1. 创建所需的目录结构
2. 复制程序文件到指定位置
3. 配置系统服务
4. 安装依赖包
5. 设置权限

### 6.3 系统服务
- 通过systemd管理服务的启动、停止和开机自启
- 支持通过systemctl命令管理服务状态
- 提供启动脚本和参数恢复脚本

## 7. 接口设计

### 7.1 命令行接口
```
industrial-scene-optimizer [options]

选项:
  -h, --help      显示帮助信息
  -c, --config    指定配置文件路径
  -m, --mode      指定运行模式（0:持续监控，1:单次运行）
  --debug         启用调试模式
```

### 7.2 服务接口
```
systemctl start industrial-scene-optimizer    # 启动服务
systemctl stop industrial-scene-optimizer     # 停止服务
systemctl status industrial-scene-optimizer   # 查看服务状态
systemctl enable industrial-scene-optimizer   # 设置开机自启
systemctl disable industrial-scene-optimizer  # 禁用开机自启
```

### 7.3 模块间接口
各模块通过类方法和返回值进行交互，主要接口如下：
- DataTransformer.get_recognition_data(): 返回识别数据
- SceneRecognizer.recognize_scene(): 返回识别的场景
- ParamOptimizer.apply_scene_params(): 应用场景参数

## 8. 异常处理与日志

### 8.1 异常处理机制
- 每个模块都包含完善的异常捕获和处理逻辑
- 对关键操作进行异常处理，确保系统稳定运行
- 提供详细的错误信息，便于问题诊断

### 8.2 日志系统
- 使用Python的logging模块实现日志功能
- 支持配置日志级别、日志文件路径
- 记录关键操作和错误信息
- 提供多级别日志（DEBUG、INFO、WARNING、ERROR、CRITICAL）

## 9. 安全性设计

### 9.1 权限管理
- 服务运行需要root权限，以应用系统参数
- 安装脚本需要root权限执行
- 文件和目录权限设置合理，确保安全性

### 9.2 参数备份与恢复
- 在应用新参数前自动备份当前参数
- 提供restore_original_params脚本一键恢复原始参数
- 确保系统可以回滚到安全状态

## 10. 扩展性设计

### 10.1 模块扩展
- 模块化设计，便于添加新功能和修改现有功能
- 各模块接口清晰，耦合度低
- 支持添加新的场景类型和优化参数

### 10.2 配置扩展
- 配置文件格式简单，便于添加新的配置项
- 支持通过环境变量覆盖配置，方便在不同环境中部署

## 11. 性能优化

### 11.1 数据处理优化
- 使用pandas进行高效的数据处理
- 只处理必要的数据列，减少计算量
- 批量处理机制，提高处理效率

### 11.2 模型优化
- 使用轻量级的机器学习模型
- 优化模型加载和预测过程
- 支持模型更新和替换

## 12. 模型训练设计

### 概述
模型训练模块是工业场景优化器的核心组件之一，负责训练用于识别不同工业计算场景的机器学习模型。该模块基于`model_trainer.py`实现，提供了完整的模型训练、评估和管理功能，支持多种数据源和模型类型，为场景识别模块提供可靠的模型支持。

### 核心组件
#### ModelTrainer类
ModelTrainer类是模型训练模块的核心实现，提供了丰富的功能接口：
- **模型类型支持**：支持随机森林（Random Forest）和梯度提升（Gradient Boosting）两种主流机器学习算法
- **场景映射**：内置计算密集型、数据密集型、混合负载型和轻量负载型四种场景的映射关系
- **标准化器管理**：支持StandardScaler等多种数据标准化方法

### 数据处理功能
#### 多源数据支持
- **文件格式支持**：处理Performance_Data格式文件、CSV文件等多种数据格式
- **编码自适应**：自动尝试多种编码格式（utf-8、gb2312、gbk等）读取文件，确保中文兼容性
- **特殊格式处理**：专门支持Performance_Data的三行一组格式（特征名称行、数值数据行、场景结果行）

#### 数据预处理
- **缺失值处理**：使用中位数或0填充缺失值，确保数据完整性
- **特征选择**：基于RandomForestClassifier实现特征重要性评估和自动特征选择
- **数据标准化**：应用StandardScaler等标准化方法，提升模型训练效果
- **重复列合并**：自动检测并合并相同名称的特征列

#### 模拟数据生成
提供`generate_simulation_data`方法，可根据不同场景特点生成模拟训练数据：
- 计算密集型场景：CPU相关特征值较高，I/O特征值较低
- 数据密集型场景：I/O相关特征值较高，CPU特征值中等
- 混合负载型场景：CPU和I/O特征值都较高
- 轻量负载型场景：所有特征值都较低

### 模型训练流程
#### 训练入口
提供多种训练入口方法，适应不同使用场景：
- `train`：基础训练方法，接收特征矩阵和标签
- `train_from_files`：从文件加载数据进行训练
- `train_from_dataframe`：从DataFrame加载数据进行训练
- `train_with_performance_data`：专门处理Performance_Data格式文件
- `train_with_simulation_data`：使用模拟数据进行训练
- `train_all_hpc_scenes`：一站式训练所有HPC场景识别模型

#### 训练过程
1. **数据准备**：分割训练集和测试集，执行特征选择（可选），应用数据标准化
2. **超参数调优**：可选的网格搜索超参数优化过程
3. **模型训练**：使用选定的算法和参数训练模型
4. **交叉验证**：执行5折交叉验证，评估模型稳定性
5. **特征重要性分析**：分析并记录关键特征的重要性排名
6. **模型保存**：自动保存训练好的模型到指定路径

#### 模型评估
训练过程中自动计算并记录多种评估指标：
- **准确率（Accuracy）**：模型预测正确的样本比例
- **精确率（Precision）**：预测为正类的样本中实际为正类的比例
- **召回率（Recall）**：实际为正类的样本中被正确预测的比例
- **F1分数**：精确率和召回率的调和平均值
- **分类报告**：详细的类别级评估指标
- **混淆矩阵**：展示模型在各类别上的预测表现

### 可视化功能
提供`visualize_results`方法，生成训练结果的可视化图表：
- **混淆矩阵热力图**：直观展示模型在各类别上的预测表现
- **交叉验证分数图**：展示不同折数的验证结果和平均分数

### 系统集成
- **命令行接口**：支持通过命令行参数配置训练过程
- **场景识别集成**：训练好的模型可被场景识别模块调用，用于自动识别工业场景
- **参数优化联动**：识别结果直接用于参数优化模块，应用相应场景的优化参数

### 容错与降级机制
- **数据格式容错**：支持多种格式解析策略，当主解析方法失败时自动尝试降级方案
- **缺失数据处理**：智能处理缺失值，确保在数据不完整时仍能训练模型
- **模拟数据支持**：当真实数据不可用时，可使用模拟数据进行模型训练

### 配置与依赖
- **关键依赖**：pandas、numpy、scikit-learn、matplotlib、seaborn
- **默认配置**：内置合理的默认参数，包括决策树数量、测试集比例等
- **自定义配置**：支持通过参数灵活调整训练过程的各个环节

## 13. 总结与展望

工业场景优化器是一个面向工业环境的高性能计算场景识别与参数优化系统。通过智能化的场景识别和参数优化，该系统能够显著提高工业计算环境的性能和资源利用效率，降低能耗，为企业节省运营成本。

系统设计遵循了模块化、可扩展性和兼容性的原则，采用了分层架构设计，各个模块之间通过清晰的接口进行交互。数据流程设计注重数据的完整性和实时性，配置管理支持灵活的参数配置，部署架构支持多种部署方式，接口设计简洁明了，异常处理机制完善，安全性考虑周全。模型训练模块提供了完整的机器学习支持，通过多源数据处理、灵活的训练流程和全面的评估机制，确保场景识别的准确性和可靠性。

展望未来，我们计划从以下几个具体方向进行优化和扩展：

### 1. 算法优化方向
- **场景识别算法改进**：引入深度学习模型（如CNN、RNN或Transformer）提升复杂场景的识别准确率
- **实时性优化**：通过模型压缩和量化技术，减少推理时间，实现毫秒级的场景识别响应
- **自学习能力增强**：添加在线学习机制，使模型能够根据新数据持续进化，适应环境变化
- **多模态特征融合**：结合系统日志、性能指标、硬件状态等多源数据，提升场景理解的全面性

### 2. 功能扩展方向
- **场景库扩充**：增加更多细分场景类型，如AI训练、科学计算、边缘计算等专用场景
- **参数覆盖范围扩展**：支持更多系统参数和硬件配置，如GPU优化、存储分层策略等
- **云原生支持**：增加对容器化环境和云平台的适配，支持Kubernetes集群的参数优化
- **跨平台兼容性**：增强对不同Linux发行版、Windows和国产操作系统的支持

### 3. 用户体验优化
- **可视化管理界面**：开发Web或桌面图形界面，提供直观的场景监控和参数配置功能
- **智能报告生成**：自动生成系统优化前后的性能对比报告，直观展示优化效果
- **参数推荐解释**：增加"为什么推荐这些参数"的解释功能，提升用户信任度
- **操作审计日志**：记录所有系统变更，支持操作回溯和问题排查

### 4. 系统集成能力
- **API接口标准化**：提供RESTful API和SDK，支持与第三方系统无缝集成
- **监控系统对接**：适配Prometheus、Grafana等主流监控系统，实现数据共享和联动
- **自动化工具链集成**：支持与CI/CD、自动化运维平台对接，实现优化流程自动化
- **容器化部署方案**：提供Docker镜像和Helm Chart，简化大规模部署和管理

### 5. 性能与可扩展性
- **分布式架构支持**：升级为分布式架构，支持大规模集群的统一管理和优化
- **高可用设计**：实现服务高可用，确保优化过程不影响业务运行
- **资源消耗优化**：降低优化器自身的资源占用，适合在资源受限环境运行
- **大数据处理能力**：增强对TB级以上性能数据的处理能力，支持长期趋势分析

### 6. 安全性与稳定性
- **权限管理机制**：细化用户权限，支持多角色访问控制
- **参数安全验证**：增加参数变更前的安全性验证，防止配置错误
- **回滚机制增强**：提供快速回滚能力，确保系统在异常情况下能够恢复到安全状态
- **漏洞扫描集成**：定期扫描系统组件的安全漏洞，确保系统安全

通过以上优化方向的实施，工业场景优化器将能够更好地满足工业环境下不同系统的性能优化需求，为用户提供更加全面、高效、智能的工业场景优化解决方案。